

Laravel Sail プロジェクトを Lightsail で本番動作させるまで

１. Lightsail インスタンスの作成

Ubuntu 22.04 を選択
SSH 接続するための秘密鍵ファイル（プライベートキー）をダウンロード

２. SSH 接続設定

VSCodeの拡張機能 [Remote - SSH] をインストール

キーの権限設定:

chmod 600 ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem

SSH 設定ファイル (VSCode内)

Host lightsail-laravel
    HostName 54.250.78.19
    User ubuntu
    IdentityFile ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem

SSH 接続確認

ssh -i ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem ubuntu@54.250.78.19

３. パッケージの更新 & ツール統合インストール

# パッケージリストを更新し、既存のソフトを最新にする
sudo apt update && sudo apt upgrade -y
# Docker, docker-compose, git, unzip をインストール
sudo apt install -y docker.io docker-compose git unzip
# ubuntu ユーザーに docker グループ権限を与える（sudo なしで docker 実行可能に）
sudo usermod -aG docker ubuntu

４. GitHub からプロジェクトクローン

git clone https://github.com/junjimoriyama/laravel-quiz-qpp.git
cd laravel-quiz-qpp

５. Laravel 環境設定

cp .env.example .env
nano .env

.env は必要に応じてAPP_URL, DB_USERNAME, DB_PASSWORDを変更

６. Composer install
# 開発環境のlaravelプロジェクトのcomposer.json に書かれた依存情報を元に本番環境でも 開発時と全く同じ Laravel の動作環境を再現する。
# カレントディレクトリを Docker 内の /app にマウント（共有）
# 作業ディレクトリを /app に設定
# Laravelの依存パッケージをインストール（bcmath 拡張がなくても続行）

docker run --rm \
  -v $(pwd):/app \
  -w /app \
  composer install --ignore-platform-req=ext-bcmath

７. Sail 起動

./vendor/bin/sail up -d

容量不足の場合: Swap 設定

sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

８. Laravel 開始

./vendor/bin/sail artisan key:generate

９. DB接続問題の解決

.env内:

DB_USERNAME=sail
DB_PASSWORD=password

MySQLコンテナが動いてることを確認: docker ps

１０. セッション / ログイン

sessions テーブルをマイグレーション

./vendor/bin/sail artisan migrate

１１. レベルデータ (LevelSeeder) の作成

./vendor/bin/sail artisan make:seeder LevelSeeder

database/seeders/LevelSeeder.php

use App\Models\Level;

Level::insert([
  ['key' => 'basic', 'label' => '初級'],
  ['key' => 'mid', 'label' => '中級'],
  ['key' => 'pro', 'label' => '上級'],
]);

１２. Seeder 実行

./vendor/bin/sail artisan db:seed --class=LevelSeeder

１３. git pull による本番コード反映

mv database/seeders/LevelSeeder.php backup_LevelSeeder.php
# Git pull
git pull origin main
# 必要であれば LevelSeeder.php を元に戻す
mv backup_LevelSeeder.php database/seeders/LevelSeeder.php

１４. バージョン管理

git remote set-url origin https://github.com/ユーザ名/新リポジトリ.git

上記の所有手順は、Laravel Sail + Docker の開発環境を Lightsail 上に本番投入するための正規的なフローです。
追加する情報やステップがあれば追加できます！

































ssh -i ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem ubuntu@54.250.78.19

１,lightsailでインスタンス作成
・ubuntu22.04

2,Lightsail に SSH 接続する
・VSCodeで [Remote - SSH 拡張機能] をインストール
・ターミナルでchmod 600 ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem実行
・VSCodeのSSH設定ファイルを開く
記述
Host lightsail-laravel
    HostName 54.250.78.19  # ← 自分のパブリックIP
    User ubuntu
    IdentityFile ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem

・ssh -i ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem ubuntu@54.250.78.19をプロジェクトのターミナルに入力→yesボタンクリック

3,新しく開いたvscodeで設定
パッケージ情報を更新＆必要なアップデートを自動実行（-y で確認省略）、必要なツール（Docker / Git / unzip など）を一括でインストール、ubuntu ユーザーを Docker グループに追加（sudo なしで docker を使えるように）
・ubuntu@ip-172-26-1-173:~$ sudo apt update && sudo apt upgrade -y
　sudo apt install -y docker.io docker-compose git unzip
　sudo usermod -aG docker ubuntu　をまとめて実行

ubuntu@ip-172-26-1-173:~$ git clone https://github.com/junjimoriyama/laravel-quiz-qpp.git
Cloning into 'laravel-quiz-qpp'...
Username for 'https://github.com': 
Password for 'https://junjimoriyama@github.com': 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
・GitHub からのクローン
cd laravel-quiz-qppでubuntu@ip-172-26-1-173:~/laravel-quiz-qpp$ なるのを確認

cp .env.example .env
↓
nano .env

一番下にカーソルがある状態で…

Ctrl + O を押す（Oはオーです）
　→ File Name to Write: .env と表示される

そのまま Enter を押す（上書き保存）

次に Ctrl + X で Nano を終了します


・docker run --rm \
  -v $(pwd):/app \
  -w /app \
  composer install
を実行

↓ エラーになる

sudo apt update && sudo apt upgrade -y\
↓
sudo apt install -y docker.io docker-compose git unzip
↓
新しいカーネルが利用可能なので再起動すると反映されますよ」というお知らせ enter
↓
アップグレードによってライブラリが更新されたため、影響を受けるサービス（デーモン）を再起動しますか？」という確認画面 enter
↓
sudo usermod -aG docker ubuntu
↓
exit
↓
ssh -i ~/Downloads/LightsailDefaultKey-ap-northeast-1.pem ubuntu@54.250.78.19
↓
cd laravel-quiz-qpp
↓
# composer install（初回のみ）
docker run --rm \
  -v $(pwd):/app \
  -w /app \
  composer install --ignore-platform-req=ext-bcmath

↓  
./vendor/bin/sail up -d
↓
容量不足でエラー

sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile　※一つずつ実行

↓↓↓

ubuntu@ip-172-26-1-173:~/laravel-quiz-qpp$ ./vendor/bin/sail up -d
laravel-quiz-qpp_laravel.test_1   start-container   Exit 0        
Shutting down old Sail processes...
Creating network "laravel-quiz-qpp_sail" with driver "bridge"
Creating laravel-quiz-qpp_mysql_1 ... done
Creating laravel-quiz-qpp_laravel.test_1 ... done

・無事にIpアドレスで接続できる

・ ./vendor/bin/sail artisan key:generate

・LaravelがMySQLに接続できない

DB_USERNAME=laravel  # これが正しい場合、そのまま
DB_PASSWORD=secret    # 正しいパスワードに変更

cd laravel-quiz-qpp



sessions テーブルのマイグレーションを実行
./vendor/bin/sail artisan migrate

・ログイン情報ない　シーダーをマイグレーション

・レベルのデータがない
開発用データベースと本番用データベースは別であり引き継げない


cd ~/laravel-quiz-qpp
Username: junjimoriyama
Password: [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]


